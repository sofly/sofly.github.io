var U=Object.defineProperty,Y=Object.defineProperties;var K=Object.getOwnPropertyDescriptors;var W=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable;var $=(e,t,n)=>t in e?U(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,S=(e,t)=>{for(var n in t||(t={}))Z.call(t,n)&&$(e,n,t[n]);if(W)for(var n of W(t))J.call(t,n)&&$(e,n,t[n]);return e},I=(e,t)=>Y(e,K(t));import{r as m,j as F,c as N,R as Q,a as X}from"./vendor.4f4ef0d1.js";const q=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerpolicy&&(a.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?a.credentials="include":s.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}};q();var b;(function(e){e.Idle="idle",e.Failed="failed",e.Fetched="fetched",e.Fetching="fetching",e.Refetching="refetching"})(b||(b={}));const ee=e=>typeof(e==null?void 0:e.error)=="string"?e.error:typeof(e==null?void 0:e.message)=="string"?e.message:String(e),w=e=>{const t=m.exports.useRef();return t.current||(t.current=e()),t.current};var p;(function(e){e.Idle="idle",e.Initializing="initializing",e.Ready="ready",e.Failed="failed",e.AccessDenied="access-denied",e.OverconstrainedError="overconstrained-error"})(p||(p={}));class te extends Error{constructor(t){super(t);this.name="OverconstrainedError"}}const ne=({videoRef:e,streamWidth:t,streamHeight:n,streamAspectRatio:r,capabilities:s})=>{const[a,i]=m.exports.useState({state:p.Idle,error:null,stream:null,errorMessage:null}),l=m.exports.useRef(a);l.current=a;const c=w(()=>({createStream:async()=>{var o,g,h,_;try{i(f=>I(S({},f),{state:p.Initializing}));const u=await window.navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:{ideal:t},height:{ideal:n},aspectRatio:{ideal:r}},audio:!1});if(l.current.stream=u,s&&!{}.VITE_IS_LOCAL_BUILD){const v=u.getVideoTracks()[0].getCapabilities();if(((g=(o=v==null?void 0:v.width)==null?void 0:o.max)!=null?g:0)<s.width||((_=(h=v==null?void 0:v.height)==null?void 0:h.max)!=null?_:0)<s.height)throw new te("Camera capabilities is not supported")}e.current.srcObject=u,i(f=>I(S({},f),{stream:u,state:p.Ready}))}catch(u){let f=p.Failed;(u==null?void 0:u.name)==="NotAllowedError"&&(f=p.AccessDenied),(u==null?void 0:u.name)==="OverconstrainedError"&&(f=p.OverconstrainedError),i(v=>I(S({},v),{error:u,state:f,errorMessage:ee(u)}))}},stopStream:()=>{var o;(o=l.current.stream)==null||o.getTracks().forEach(g=>g.stop())}})),d=w(()=>({isStateIdle:()=>l.current.state===p.Idle,isStateReady:()=>l.current.state===p.Ready,isStateFailed:()=>l.current.state===p.Failed,isStateInitializing:()=>l.current.state===p.Initializing,isStateAccessDenied:()=>l.current.state===p.AccessDenied,isStateOverconstrainedError:()=>l.current.state===p.OverconstrainedError}));return m.exports.useEffect(()=>c.stopStream,[]),[a,c,d]},V={isPlaying:!1,isLoadedMetaData:!1},se=()=>{const[e,t]=m.exports.useState(V),n=w(()=>({videoPlaying:()=>{t(r=>I(S({},r),{isPlaying:!0}))},videoLoadedMetadata:()=>{t(r=>I(S({},r),{isLoadedMetaData:!0}))},resetVideoState:()=>t(V)}));return[e,n]},ae=[61,185,40,39,37,0,267,269,270,409,291,375,321,405,314,17,84,181,91,146],re=[130,113,124,156,70,63,105,66,107,55,221,189,244,243,112,26,22,23,24,110,25],oe=[359,255,339,254,253,252,256,341,463,464,413,441,285,336,296,334,293,300,383,353,342],ie=[166,60,99,97,2,326,328,290,392,309,458,461,354,19,125,241,238,79];function ce(){let e=null;return{push:t=>{if(!e)return;const n=e;e=null,setTimeout(()=>{n(t)},0)},pull:()=>new Promise((t,n)=>{e=t})}}const le=()=>{const[e,t]=m.exports.useState();return m.exports.useEffect(()=>{(async()=>{const r=new window.FaceMesh({locateFile:a=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${a}`});r.setOptions({maxNumFaces:1,refineLandmarks:!0,minTrackingConfidence:.3,minDetectionConfidence:.3});const s=ce();r.onResults(a=>s.push(a)),await r.initialize(),t({detect:async a=>{r.send({image:a});const i=await s.pull();if(!i.multiFaceLandmarks[0])return null;const{videoWidth:l,videoHeight:c}=a,d=i.multiFaceLandmarks[0].map(o=>[o.x*l,o.y*c]);return{lips:ae.map(o=>d[o]),nose:ie.map(o=>d[o]),leftEye:re.map(o=>d[o]),rightEye:oe.map(o=>d[o]),silhouette:window.FACEMESH_FACE_OVAL.map(([o])=>d[o])}}})})()},[]),e},M={WIDTH:320,HEIGHT:240,ASPECT_RATIO:4/3},de="_imageWrapper_1dmeb_1",ue="_canvas_1dmeb_12";var j={imageWrapper:de,canvas:ue};const E=F.exports.jsx,y=F.exports.jsxs,fe=F.exports.Fragment,me=({width:e,height:t,className:n,illuminationCanvasRef:r})=>E("div",{className:N(j.imageWrapper,n),children:E("canvas",{width:e,height:t,ref:r,className:j.canvas})});var pe=m.exports.memo(me);const z=({width:e,height:t})=>w(()=>{const n=document.createElement("canvas");return n.width=e,n.height=t,[n,n.getContext("2d")]}),ge=()=>{const e=m.exports.useRef({isRunning:!1,shouldStop:!1}),t=()=>{e.current.isRunning=!1,e.current.shouldStop=!1},n=w(()=>({run:r=>{if(e.current.isRunning)return;e.current.isRunning=!0;let s=null;async function a(i=0){if(e.current.shouldStop){t();return}const l=i-(s!=null?s:0);if(s===null||l>16){if(await r(),e.current.shouldStop){t();return}s=i}window.requestAnimationFrame(a)}a()},stop:()=>{e.current.shouldStop=!0}}));return[e.current.isRunning,n]},he=e=>((e[0][0]!==e[e.length-1][0]||e[0][1]!==e[e.length-1][1])&&e.push(e[0]),e.reduce((t,[n,r],s)=>s===0?`${t}M ${n} ${r} `:e.length-1===s?`${t}L ${n} ${r} Z `:`${t}L ${n} ${r} `,"")),ve=({ctx:e,input:t})=>e.drawImage(t,0,0),ye=({ctx:e,width:t,height:n})=>{e.fillStyle="#000000",e.fillRect(0,0,t,n)},_e=({ctx:e,width:t,height:n})=>{e.clearRect(0,0,t,n)},B=({ctx:e,fill:t="black",points:n})=>{let r=new Path2D(he(n));e.fillStyle=t,e.fill(r)},Ee=({ctx:e,faceMesh:t})=>{B({ctx:e,fill:"white",points:t.silhouette}),[t.lips,t.nose,t.leftEye,t.rightEye].forEach(n=>B({ctx:e,points:n}))},we=250/255,xe=225/255,Se=(e,t)=>t>xe||e>we?1:0,Ie=({width:e,height:t,maskCtx:n,imageCtx:r})=>{const s=[],{data:a}=n.getImageData(0,0,e,t),{data:i}=r.getImageData(0,0,e,t),l=e*4;let c,d=0,o=0,g=0,h,_,u,f,v,O,x,D,T=0,C=0,k=0,R=0,P=0;for(;d<e;d+=1)for(c=d*4,o=0;o<t;o+=1){g=o*l+c,h=i[g]/255,_=i[g+1]/255,u=i[g+2]/255,f=h*.299,v=_*.587,O=u*.114,x=h*_*u/3,D=f+v+O,C+=D;const H=Se(h,x);a[g]===0?(R<x&&(R=x),P+=H):(s.push(d,o,H,D),T+=1,k<x&&(k=x))}const G=C/(e*t);let A=R;return G>.4?A=k:R<.3&&(A=.3),{pixelsInFace:T,luminanceFace:s,shadowThreshold:A,maxFaceIlluminance:k,maxBackgroundIlluminance:R,backgroundSaturationPixels:P}},Re=({width:e,height:t,luminanceFace:n,shadowThreshold:r,illuminationCanvasCtx:s})=>{let a=0,i=0;_e({ctx:s,width:e,height:t});const{length:l}=n;let c=0;for(;c<l;c+=4)n[c+3]<r&&(a+=1,s.fillStyle="rgba(86, 29, 247, 1)",s.fillRect(n[c],n[c+1],1,1)),n[c+2]===1&&(i+=1,s.fillStyle="rgba(255, 182, 171, 1)",s.fillRect(n[c],n[c+1],1,1));return{shadowPixels:a,saturationPixels:i}},Le=({width:e,height:t,videoNode:n,faceDetector:r,illuminationCanvasRef:s})=>{const[a,i]=m.exports.useState({algorithmMs:0,shadowValue:0,faceDetectionMs:0,saturationValue:0,shadowImageMask:"",saturationImageMask:"",backgroundSaturationValue:0}),[,l]=ge(),[,c]=z({width:e,height:t}),[,d]=z({width:e,height:t}),o=w(()=>async()=>{const h=s.current,_=h==null?void 0:h.getContext("2d"),u=await r.detect(n);if(u){ve({ctx:d,input:n}),ye({ctx:c,width:e,height:t}),Ee({ctx:c,faceMesh:u});const f=Ie({width:e,height:t,maskCtx:c,imageCtx:d});console.log(f.shadowThreshold),Re({width:e,height:t,luminanceFace:f.luminanceFace,shadowThreshold:f.shadowThreshold,illuminationCanvasCtx:_})}}),g=w(()=>({check:()=>{l.run(o)},stopChecking:()=>{l.stop()}}));return[a,g]},ke="_imageWrapper_138pw_1",De="_mask_138pw_12",Ae="_info_138pw_21";var Fe={imageWrapper:ke,mask:De,info:Ae};const Me=({width:e,height:t,videoNode:n,faceDetector:r})=>{const s=m.exports.useRef(null),[a,i]=Le({width:e,height:t,videoNode:n,faceDetector:r,illuminationCanvasRef:s});return m.exports.useEffect(()=>(i.check(),i.stopChecking),[]),y(fe,{children:[E(pe,{width:e,height:t,illuminationCanvasRef:s}),y("div",{className:Fe.info,children:[y("p",{children:["Face detection duration: ",a.faceDetectionMs,"ms"]}),y("p",{children:["Algorithm duration: ",a.algorithmMs,"ms"]}),y("p",{children:["Shadow value: ",a.shadowValue.toFixed(2)]}),y("p",{children:["Saturation value: ",a.saturationValue.toFixed(2)]}),y("p",{children:["Background saturation value: ",a.backgroundSaturationValue.toFixed(2)]})]})]})};var Oe=m.exports.memo(Me);const Te="_wrapper_1o99e_1",Ce="_ready_1o99e_9",Pe="_video_1o99e_9",He="_loader_1o99e_13",We="_videoWrapper_1o99e_17";var L={wrapper:Te,ready:Ce,video:Pe,loader:He,videoWrapper:We};function $e(){var o;const e=m.exports.useRef(null),t=le(),[n,r]=se(),[s,a,i]=ne({videoRef:e,streamWidth:M.WIDTH,streamHeight:M.HEIGHT,streamAspectRatio:M.ASPECT_RATIO});m.exports.useEffect(()=>{a.createStream()},[]);const l=!!t&&n.isPlaying&&n.isLoadedMetaData&&i.isStateReady(),c=(o=s.stream)==null?void 0:o.getVideoTracks()[0],d=c==null?void 0:c.getSettings();return y("div",{className:N(L.wrapper,{[L.ready]:l}),children:[y("div",{className:L.videoWrapper,children:[E("video",{ref:e,muted:!0,onPlay:r.videoPlaying,autoPlay:!0,controls:!1,className:L.video,playsInline:!0,onLoadedMetadata:r.videoLoadedMetadata}),l&&E(Oe,{width:d==null?void 0:d.width,height:d==null?void 0:d.height,videoNode:e.current,faceDetector:t})]}),E("div",{className:L.loader,children:"Loading..."})]})}Q.render(E(X.StrictMode,{children:E($e,{})}),document.getElementById("root"));
