var U=Object.defineProperty,Y=Object.defineProperties;var K=Object.getOwnPropertyDescriptors;var b=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable;var V=(e,t,a)=>t in e?U(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,_=(e,t)=>{for(var a in t||(t={}))Z.call(t,a)&&V(e,a,t[a]);if(b)for(var a of b(t))J.call(t,a)&&V(e,a,t[a]);return e},E=(e,t)=>Y(e,K(t));import{r as f,j as T,c as W,R as Q,a as X}from"./vendor.bd12f3e5.js";const q=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function a(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerpolicy&&(s.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?s.credentials="include":n.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=a(n);fetch(n.href,s)}};q();var $;(function(e){e.Idle="idle",e.Failed="failed",e.Fetched="fetched",e.Fetching="fetching",e.Refetching="refetching"})($||($={}));const ee=e=>typeof(e==null?void 0:e.error)=="string"?e.error:typeof(e==null?void 0:e.message)=="string"?e.message:String(e),I=e=>{const t=f.exports.useRef();return t.current||(t.current=e()),t.current};var g;(function(e){e.Idle="idle",e.Initializing="initializing",e.Ready="ready",e.Failed="failed",e.AccessDenied="access-denied",e.OverconstrainedError="overconstrained-error"})(g||(g={}));class te extends Error{constructor(t){super(t);this.name="OverconstrainedError"}}const ae=({videoRef:e,streamWidth:t,streamHeight:a,streamAspectRatio:r,capabilities:n})=>{const[s,i]=f.exports.useState({state:g.Idle,error:null,stream:null,errorMessage:null}),l=f.exports.useRef(s);l.current=s;const c=I(()=>({createStream:async()=>{var o,v,y,w;try{i(p=>E(_({},p),{state:g.Initializing}));const u=await window.navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:{ideal:t},height:{ideal:a},aspectRatio:{ideal:r}},audio:!1});if(l.current.stream=u,n&&!{}.VITE_IS_LOCAL_BUILD){const h=u.getVideoTracks()[0].getCapabilities();if(((v=(o=h==null?void 0:h.width)==null?void 0:o.max)!=null?v:0)<n.width||((w=(y=h==null?void 0:h.height)==null?void 0:y.max)!=null?w:0)<n.height)throw new te("Camera capabilities is not supported")}e.current.srcObject=u,i(p=>E(_({},p),{stream:u,state:g.Ready}))}catch(u){let p=g.Failed;(u==null?void 0:u.name)==="NotAllowedError"&&(p=g.AccessDenied),(u==null?void 0:u.name)==="OverconstrainedError"&&(p=g.OverconstrainedError),i(h=>E(_({},h),{error:u,state:p,errorMessage:ee(u)}))}},stopStream:()=>{var o;(o=l.current.stream)==null||o.getTracks().forEach(v=>v.stop())}})),d=I(()=>({isStateIdle:()=>l.current.state===g.Idle,isStateReady:()=>l.current.state===g.Ready,isStateFailed:()=>l.current.state===g.Failed,isStateInitializing:()=>l.current.state===g.Initializing,isStateAccessDenied:()=>l.current.state===g.AccessDenied,isStateOverconstrainedError:()=>l.current.state===g.OverconstrainedError}));return f.exports.useEffect(()=>c.stopStream,[]),[s,c,d]},N={isPlaying:!1,isLoadedMetaData:!1},ne=()=>{const[e,t]=f.exports.useState(N),a=I(()=>({videoPlaying:()=>{t(r=>E(_({},r),{isPlaying:!0}))},videoLoadedMetadata:()=>{t(r=>E(_({},r),{isLoadedMetaData:!0}))},resetVideoState:()=>t(N)}));return[e,a]},se=[61,185,40,39,37,0,267,269,270,409,291,375,321,405,314,17,84,181,91,146],re=[130,113,124,156,70,63,105,66,107,55,221,189,244,243,112,26,22,23,24,110,25],oe=[359,255,339,254,253,252,256,341,463,464,413,441,285,336,296,334,293,300,383,353,342],ie=[166,60,99,97,2,326,328,290,392,309,458,461,354,19,125,241,238,79];function ce(){let e=null;return{push:t=>{if(!e)return;const a=e;e=null,setTimeout(()=>{a(t)},0)},pull:()=>new Promise((t,a)=>{e=t})}}const le=()=>{const[e,t]=f.exports.useState();return f.exports.useEffect(()=>{(async()=>{const r=new window.FaceMesh({locateFile:s=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${s}`});r.setOptions({maxNumFaces:1,refineLandmarks:!0,minTrackingConfidence:.3,minDetectionConfidence:.3});const n=ce();r.onResults(s=>n.push(s)),await r.initialize(),t({detect:async s=>{r.send({image:s});const i=await n.pull();if(!i.multiFaceLandmarks[0])return null;const{videoWidth:l,videoHeight:c}=s,d=i.multiFaceLandmarks[0].map(o=>[o.x*l,o.y*c]);return{lips:se.map(o=>d[o]),nose:ie.map(o=>d[o]),leftEye:re.map(o=>d[o]),rightEye:oe.map(o=>d[o]),silhouette:window.FACEMESH_FACE_OVAL.map(([o])=>d[o])}}})})()},[]),e},P={WIDTH:320,HEIGHT:240,ASPECT_RATIO:4/3},de="_imageWrapper_1dmeb_1",ue="_canvas_1dmeb_12";var j={imageWrapper:de,canvas:ue};const S=T.exports.jsx,x=T.exports.jsxs,fe=T.exports.Fragment,pe=({width:e,height:t,className:a,illuminationCanvasRef:r})=>S("div",{className:W(j.imageWrapper,a),children:S("canvas",{width:e,height:t,ref:r,className:j.canvas})});var me=f.exports.memo(pe);const z=({width:e,height:t})=>I(()=>{const a=document.createElement("canvas");return a.width=e,a.height=t,[a,a.getContext("2d")]}),ge=()=>{const e=f.exports.useRef({isRunning:!1,shouldStop:!1}),t=()=>{e.current.isRunning=!1,e.current.shouldStop=!1},a=I(()=>({run:r=>{if(e.current.isRunning)return;e.current.isRunning=!0;let n=null;async function s(i=0){if(e.current.shouldStop){t();return}const l=i-(n!=null?n:0);if(n===null||l>16){if(await r(),e.current.shouldStop){t();return}n=i}window.requestAnimationFrame(s)}s()},stop:()=>{e.current.shouldStop=!0}}));return[e.current.isRunning,a]},he=e=>((e[0][0]!==e[e.length-1][0]||e[0][1]!==e[e.length-1][1])&&e.push(e[0]),e.reduce((t,[a,r],n)=>n===0?`${t}M ${a} ${r} `:e.length-1===n?`${t}L ${a} ${r} Z `:`${t}L ${a} ${r} `,"")),ve=({ctx:e,input:t})=>e.drawImage(t,0,0),ye=({ctx:e,width:t,height:a})=>{e.fillStyle="#000000",e.fillRect(0,0,t,a)},xe=({ctx:e,width:t,height:a})=>{e.clearRect(0,0,t,a)},B=({ctx:e,fill:t="black",points:a})=>{let r=new Path2D(he(a));e.fillStyle=t,e.fill(r)},we=({ctx:e,faceMesh:t})=>{B({ctx:e,fill:"white",points:t.silhouette}),[t.lips,t.nose,t.leftEye,t.rightEye].forEach(a=>B({ctx:e,points:a}))},Se=250/255,_e=225/255,Ee=(e,t)=>t>_e||e>Se?1:0,Ie=({width:e,height:t,maskCtx:a,imageCtx:r})=>{const n=[],{data:s}=a.getImageData(0,0,e,t),{data:i}=r.getImageData(0,0,e,t),l=e*4;let c,d=0,o=0,v=0,y,w,u,p,h,L,m,D,F=0,A=0,M=0,R=0,C=0;for(;d<e;d+=1)for(c=d*4,o=0;o<t;o+=1){v=o*l+c,y=i[v]/255,w=i[v+1]/255,u=i[v+2]/255,p=y*.299,h=w*.587,L=u*.114,m=y*w*u/3,D=p+h+L,A+=D;const H=Ee(y,m);s[v]===0?(R<m&&(R=m),C+=H):(n.push(d,o,H,D),F+=1,M<m&&(M=m))}const G=A/(e*t);let O=R;return G>.4?O=M:R<.3&&(O=.3),{pixelsInFace:F,luminanceFace:n,shadowThreshold:O,maxFaceIlluminance:M,maxBackgroundIlluminance:R,backgroundSaturationPixels:C}},De=({width:e,height:t,luminanceFace:a,shadowThreshold:r,illuminationCanvasCtx:n})=>{let s=0,i=0;xe({ctx:n,width:e,height:t});const{length:l}=a;let c=0;for(;c<l;c+=4)a[c+3]<r&&(s+=1,n.fillStyle="rgba(86, 29, 247, 1)",n.fillRect(a[c],a[c+1],1,1)),a[c+2]===1&&(i+=1,n.fillStyle="rgba(255, 182, 171, 1)",n.fillRect(a[c],a[c+1],1,1));return{shadowPixels:s,saturationPixels:i}},Re=({width:e,height:t,videoNode:a,faceDetector:r,illuminationCanvasRef:n})=>{const[s,i]=f.exports.useState({algorithmMs:0,shadowValue:0,faceDetectionMs:0,saturationValue:0,shadowImageMask:"",saturationImageMask:"",backgroundSaturationValue:0}),[,l]=ge(),[,c]=z({width:e,height:t}),[,d]=z({width:e,height:t}),o=I(()=>async()=>{const y=n.current,w=y==null?void 0:y.getContext("2d"),u=Date.now(),p=await r.detect(a),h=Date.now()-u;if(p){const L=Date.now();ve({ctx:d,input:a}),ye({ctx:c,width:e,height:t}),we({ctx:c,faceMesh:p});const m=Ie({width:e,height:t,maskCtx:c,imageCtx:d});console.log(m.shadowThreshold);const{shadowPixels:D,saturationPixels:F}=De({width:e,height:t,luminanceFace:m.luminanceFace,shadowThreshold:m.shadowThreshold,illuminationCanvasCtx:w});i(A=>E(_({},A),{algorithmMs:Date.now()-L,faceDetectionMs:h,shadowValue:D/m.pixelsInFace,saturationValue:F/m.pixelsInFace,backgroundSaturationValue:m.backgroundSaturationPixels/(e*t-m.pixelsInFace)}))}}),v=I(()=>({check:()=>{l.run(o)},stopChecking:()=>{l.stop()}}));return[s,v]},ke="_imageWrapper_138pw_1",Le="_mask_138pw_12",Fe="_info_138pw_21";var Ae={imageWrapper:ke,mask:Le,info:Fe};const Me=({width:e,height:t,videoNode:a,faceDetector:r})=>{const n=f.exports.useRef(null),[s,i]=Re({width:e,height:t,videoNode:a,faceDetector:r,illuminationCanvasRef:n});return f.exports.useEffect(()=>(i.check(),i.stopChecking),[]),x(fe,{children:[S(me,{width:e,height:t,illuminationCanvasRef:n}),x("div",{className:Ae.info,children:[x("p",{children:["Face detection duration: ",s.faceDetectionMs,"ms"]}),x("p",{children:["Algorithm duration: ",s.algorithmMs,"ms"]}),x("p",{children:["Shadow value: ",s.shadowValue.toFixed(2)]}),x("p",{children:["Saturation value: ",s.saturationValue.toFixed(2)]}),x("p",{children:["Background saturation value: ",s.backgroundSaturationValue.toFixed(2)]})]})]})};var Oe=f.exports.memo(Me);const Te="_wrapper_1o99e_1",Pe="_ready_1o99e_9",Ce="_video_1o99e_9",He="_loader_1o99e_13",be="_videoWrapper_1o99e_17";var k={wrapper:Te,ready:Pe,video:Ce,loader:He,videoWrapper:be};function Ve(){var o;const e=f.exports.useRef(null),t=le(),[a,r]=ne(),[n,s,i]=ae({videoRef:e,streamWidth:P.WIDTH,streamHeight:P.HEIGHT,streamAspectRatio:P.ASPECT_RATIO});f.exports.useEffect(()=>{s.createStream()},[]);const l=!!t&&a.isPlaying&&a.isLoadedMetaData&&i.isStateReady(),c=(o=n.stream)==null?void 0:o.getVideoTracks()[0],d=c==null?void 0:c.getSettings();return x("div",{className:W(k.wrapper,{[k.ready]:l}),children:[x("div",{className:k.videoWrapper,children:[S("video",{ref:e,muted:!0,onPlay:r.videoPlaying,autoPlay:!0,controls:!1,className:k.video,playsInline:!0,onLoadedMetadata:r.videoLoadedMetadata}),l&&S(Oe,{width:d==null?void 0:d.width,height:d==null?void 0:d.height,videoNode:e.current,faceDetector:t})]}),S("div",{className:k.loader,children:"Loading..."})]})}Q.render(S(X.StrictMode,{children:S(Ve,{})}),document.getElementById("root"));
